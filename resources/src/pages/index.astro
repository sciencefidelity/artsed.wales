---
import "styles/global.css"
import sanityClient from "lib/sanityClient"
import { resourceQuery } from "lib/queries"
import { Resource } from "lib/interfaces"

const response = await sanityClient.fetch(resourceQuery)
const data = response
const { resource } = data as { resource: Resource }

const getNestedHeadings = headings => {
  const nestedHeadings = []

  headings.forEach((heading, index) => {
    const { style, children } = heading
    const { text } = children[0]

    if (heading.style === "h2") {
      nestedHeadings.push({ id: style, title: text, items: [] })
    } else if (heading.style === "h3" && nestedHeadings.length > 0) {
      nestedHeadings[nestedHeadings.length - 1].items.push({
        id: style,
        title: text
      })
    }
  })

  return nestedHeadings
}

const titles = resource.body.filter(block => block.style !== "normal")
const headings = getNestedHeadings(titles)
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width" />
    <title>Beatbox</title>
  </head>
  <body>
    <article>
      <ul>
        {headings.map(heading => (
          <li>
            <a href={`#${heading.id}`}>{heading.title}</a>
            {heading.items.length > 0 && (
              <ul>
                {heading.items.map(child => (
                  <li>
                    <a href={`#${child.id}`}>{child.title}</a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </article>
  </body>
</html>
